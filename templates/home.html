<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>{{ title or "Al Forno App Portal" }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="{{ url_for('static', filename='logo.png') }}" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; img-src 'self' data:; style-src 'self' https://fonts.googleapis.com 'unsafe-inline'; font-src https://fonts.gstatic.com; script-src 'self' 'unsafe-inline'">
  <style>
    :root{--bg:#0c1117;--grad-a:rgba(0,224,164,.10);--grad-b:rgba(124,249,203,.16);--card:#0f1520;
      --glass1:rgba(255,255,255,.05);--glass2:rgba(255,255,255,.02);--stroke:#18202b;--ink:#eaf1fb;--muted:#97a7c2;
      --chip:#122033;--ok:#27e2a4;--danger:#ff6b6b;--shadow:0 22px 50px rgba(0,0,0,.45);--info:#7ab7ff}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;color:var(--ink);
      background:radial-gradient(1000px 500px at -15% -25%, var(--grad-a), transparent 62%),
                 radial-gradient(1000px 500px at 115% -15%, var(--grad-b), transparent 60%), #0c1117;}
    a{color:inherit;text-decoration:none}
    .muted{color:var(--muted)} .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .wrap{max-width:1200px;margin:0 auto;padding:0 18px}
    header{display:flex;align-items:center;gap:12px;padding:16px 0;border-bottom:1px solid var(--stroke);
      position:sticky;top:0;background:rgba(12,17,23,.80);backdrop-filter:blur(10px);z-index:10}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{height:34px;width:auto;filter:drop-shadow(0 2px 8px rgba(0,224,164,.18))}
    .title{font-weight:800;font-size:18px;letter-spacing:.2px}
    .chip{background:var(--chip);border:1px solid var(--stroke);padding:4px 10px;border-radius:999px;font-weight:700;font-size:12px;margin-left:8px;color:#a7ffd8}
    .spacer{flex:1}
    .btn{background:linear-gradient(180deg, var(--glass1), var(--glass2));border:1px solid var(--stroke);padding:8px 12px;border-radius:12px;
      display:inline-flex;gap:8px;align-items:center;cursor:pointer;font-weight:700;box-shadow:var(--shadow)}
    .btn:hover{filter:brightness(1.05)}
    main{display:grid;grid-template-columns:240px 1fr;gap:18px;margin-top:18px}
    nav{position:sticky;top:72px;align-self:start}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--stroke);border-radius:16px;box-shadow:var(--shadow);padding:14px}
    .navlink{display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;border:1px solid transparent;font-weight:700}
    .navlink.active,.navlink:hover{border-color:var(--stroke);background:var(--chip)}
    .hamb{display:none}
    @media (max-width:900px){main{grid-template-columns:1fr}nav{position:fixed;top:64px;left:0;right:0;background:rgba(16,23,33,.98);padding:10px 14px;transform:translateY(-140%);transition:transform .2s ease}nav.open{transform:translateY(0)}.hamb{display:inline-flex}}
    footer{margin:24px 0;color:var(--muted);font-size:12px;text-align:center}

    .toolbar{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .pill{background:#0e1624;border:1px solid var(--stroke);border-radius:10px;padding:6px 10px;font-weight:700;cursor:pointer}
    .pill.active{outline:2px solid #00e0a4}
    .search{flex:0 0 320px;background:#0e1624;border:1px solid var(--stroke);border-radius:10px;padding:8px 10px;color:var(--ink)}
    .loglist{display:flex;flex-direction:column;gap:10px}
    .logrow{display:grid;grid-template-columns:110px 160px 1fr auto;gap:12px;align-items:center;
      padding:10px 12px;border:1px solid var(--stroke);background:rgba(255,255,255,.02);border-radius:12px}
    .logrow:hover{background:#121a28}
    .badge{justify-self:start;text-align:center;font-weight:800;font-size:11px;letter-spacing:.03em;border-radius:999px;padding:3px 8px}
    .badge.success{background:rgba(39,226,164,.15);color:#6affe0;border:1px solid rgba(39,226,164,.35)}
    .badge.error{background:rgba(255,107,107,.14);color:#ffb3b3;border:1px solid rgba(255,107,107,.35)}
    .badge.info{background:rgba(122,183,255,.12);color:#bcd8ff;border:1px solid rgba(122,183,255,.3)}
    .when{color:var(--muted);font-size:12px}
    .msg{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .copybtn{justify-self:end}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <button class="btn hamb" onclick="toggleNav()" aria-label="Menu">☰</button>
      <a class="brand" href="{{ url_for('home') }}">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="logo" />
        <div class="title">Al Forno App Portal</div>
      </a>
      <span class="chip">LIVE</span>
      <div class="spacer"></div>
      {% if current_user.is_authenticated %}
        <a class="btn" href="{{ url_for('profile') }}">Profile</a>
        <a class="btn" href="{{ url_for('logout') }}">Logout</a>
      {% else %}
        <a class="btn" href="{{ url_for('login') }}">Login</a>
      {% endif %}
    </header>

    <main>
      <nav id="nav">
        <a class="navlink active" href="{{ url_for('home') }}">Overview</a>
        <a class="navlink" href="{{ url_for('files_page') }}">Files</a>
        <a class="navlink" href="{{ url_for('news_list') }}">News</a>
        <a class="navlink" href="{{ url_for('contact') }}">Contact</a>
        <a class="navlink" href="{{ url_for('about') }}">About</a>
        {% if current_user.is_authenticated and current_user.role=='admin' %}
          <a class="navlink" href="{{ url_for('users_admin') }}">Users</a>
        {% endif %}
      </nav>

      <section>
        <div class="card">
          <div class="toolbar">
            <h2 style="margin:6px 8px 6px 8px">Recent activity</h2>
            <div class="spacer"></div>
            <div class="pill active" data-filter="all" onclick="setFilter(this)">All</div>
            <div class="pill" data-filter="success" onclick="setFilter(this)">Success</div>
            <div class="pill" data-filter="error" onclick="setFilter(this)">Error</div>
            <div class="pill" data-filter="info" onclick="setFilter(this)">Info</div>
            <input id="q" class="search" placeholder="Search message..." oninput="applyFilters()" />
            <button class="pill" onclick="refreshActivity()">Refresh now</button>
          </div>

          <div id="activity" class="loglist"></div>
        </div>
      </section>
    </main>

    <footer>© {{ year }} Al Forno • App Portal</footer>
  </div>

  <script>
    function toggleNav(){ document.getElementById('nav').classList.toggle('open'); }

    let ALL = [];           // server entries
    let currentFilter = 'all';

    function setFilter(el){
      document.querySelectorAll('.pill[data-filter]').forEach(p=>p.classList.remove('active'));
      el.classList.add('active');
      currentFilter = el.dataset.filter;
      applyFilters();
    }

    function copyText(txt){
      navigator.clipboard.writeText(txt).catch(()=>{});
    }

    function rowHTML(e){
      const url = "{{ url_for('log_run', run_slug='__RUN__') }}".replace("__RUN__", e.run);
      return `
        <div class="logrow">
          <span class="badge ${e.level}">${e.level === 'info' ? 'INFO' : e.level.toUpperCase()}</span>
          <span class="when mono">${e.ts}</span>
          <a class="msg mono" href="${url}" title="Open full log">${e.msg}</a>
          <button class="pill copybtn" onclick="copyText(${JSON.stringify(e.copy)})">Copy</button>
        </div>
      `;
    }

    function applyFilters(){
      const q = (document.getElementById('q').value || '').toLowerCase();
      const filtered = ALL.filter(e =>
        (currentFilter === 'all' || e.level === currentFilter) &&
        (q === '' || e.msg.toLowerCase().includes(q))
      );
      document.getElementById('activity').innerHTML = filtered.map(rowHTML).join('');
    }

    async function refreshActivity(){
      try{
        const r = await fetch('{{ url_for("api_status") }}');
        const data = await r.json();
        ALL = (data.entries || []);
        applyFilters();
      }catch(e){}
    }

    // initial load + auto refresh
    refreshActivity();
    setInterval(refreshActivity, 20000);
  </script>
</body>
</html>